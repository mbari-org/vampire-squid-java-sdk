# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Java client SDK for the [vampire-squid](https://github.com/mbari-org/vampire-squid) microservice, which manages video metadata. The SDK is primarily auto-generated using [Microsoft Kiota](https://learn.microsoft.com/en-us/openapi/kiota/overview) from an OpenAPI specification.

**Key Facts:**
- Java 21 project using Maven
- Mix of auto-generated (Kiota) and hand-written code
- Provides two API styles: Kiota fluent API and MediaService interface
- Uses JWT bearer token authentication with API keys
- All async operations use CompletableFuture with virtual threads

## Build Commands

```bash
# Clean and build
mvn clean install

# Run tests only (unit tests)
mvn test

# Run integration tests (requires live service)
mvn verify

# Run a single test class
mvn test -Dtest=SanityTest

# Run a single test method
mvn test -Dtest=VampireSquidKiotaClientIT#testAuth

# Package without running tests
mvn package -DskipTests

# Generate javadocs
mvn javadoc:javadoc

# Deploy to Maven Central (requires credentials)
mvn deploy
```

## Architecture

### Two-Layer API Design

The SDK provides two ways to interact with the vampire-squid service:

1. **Kiota Generated API** (`org.mbari.vars.vampiresquid.sdk.kiota.*`)
   - Auto-generated from OpenAPI spec
   - Fluent, builder-style API
   - Direct mapping to REST endpoints
   - Example: `vampireSquid.v1().media().sha512().bySha512(hash).get()`

2. **MediaService Interface** (`org.mbari.vars.vampiresquid.sdk.r1.*`)
   - Hand-written convenience layer
   - Business-friendly method names
   - Wraps Kiota API calls
   - Returns CompletableFuture for all operations
   - Handles 404 errors gracefully (returns null/empty lists instead of throwing)
   - Example: `mediaService.findBySha512(hash)`

### Factory Pattern

`VampireSquidFactory` creates configured Kiota client instances:
- Sets up authentication (JWT bearer token or anonymous)
- Configures OkHttp client with interceptors
- Adds debug logging when enabled
- Returns ready-to-use `VampireSquid` instance

### Authentication

`VampireSquidAccessTokenProvider` implements Kiota's `AccessTokenProvider`:
- Takes API key and auth endpoint URL
- Requests JWT token from `/v1/auth` endpoint
- Caches token until expiration
- Auto-refreshes expired tokens
- Thread-safe token management

### Models

Two parallel model hierarchies:
- **Kiota models** (`sdk.kiota.models.*`): Auto-generated, serialization-aware
- **Hand-written models** (`sdk.r1.models.*`): Convenience models with conversion methods
  - `Media.fromKiota()` and `Media.toKiota()` convert between representations

### Concurrency

- `VampireSquidKiotaClient` uses `Executors.newVirtualThreadPerTaskExecutor()`
- All operations return `CompletableFuture<T>`
- Virtual threads minimize overhead for I/O-bound operations

## Regenerating the Kiota Client

When the vampire-squid OpenAPI spec changes:

1. Copy the updated OpenAPI YAML to `src/main/resources/docs.yaml`

2. **Critical**: Modify the spec to work around Kiota limitations:
   - Change OpenAPI version to 3.0.0 if it's 3.1.0 (Kiota doesn't support 3.1.0)
   - Remove `format: binary` from all sha512 fields (Kiota assumes base64, but we use hex strings):
     ```yaml
     sha512:
       type: string
       # format: binary  # REMOVE THIS LINE
     ```

3. Run the Kiota generator from project root:
   ```bash
   kiota generate -l java \
     -c VampireSquid \
     -n org.mbari.vars.vampiresquid.sdk.kiota \
     -d ./src/main/resources/docs.yaml \
     -o ./src/main/java/org/mbari/vars/vampiresquid/sdk/kiota \
     --exclude-backward-compatible
   ```

4. Review generated code, especially:
   - Model classes in `sdk.kiota.models`
   - Request builders in `sdk.kiota.v1`
   - Ensure sha512 is treated as string, not byte array

5. Update hand-written conversion methods if model changes affect `Media.fromKiota()`/`toKiota()`

## Code Organization

```
src/main/java/org/mbari/vars/vampiresquid/sdk/
├── kiota/                          # AUTO-GENERATED by Kiota
│   ├── VampireSquid.java          # Entry point for Kiota API
│   ├── models/                    # Generated model classes
│   └── v1/                        # Generated request builders (REST endpoints)
├── r1/                            # HAND-WRITTEN convenience layer
│   ├── MediaService.java          # Interface defining business operations
│   ├── VampireSquidKiotaClient.java  # MediaService implementation
│   ├── models/                    # Hand-written models with conversions
│   └── etc/                       # Utilities (Gson converters, helpers)
├── VampireSquidFactory.java       # Factory for creating configured clients
└── VampireSquidAccessTokenProvider.java  # JWT authentication handler
```

## Common Patterns

### Creating a Client

```java
// With authentication (for write operations)
var vampireSquid = VampireSquidFactory.create(baseUrl, apiKey);

// Without authentication (read-only)
var vampireSquid = VampireSquidFactory.create(baseUrl);

// Using MediaService wrapper
var mediaService = new VampireSquidKiotaClient(URI.create(baseUrl), apiKey);
```

### Error Handling

- Kiota API throws `NotFound` exception for 404s
- MediaService catches `NotFound` and returns null (single result) or empty list (multiple results)
- This pattern avoids try-catch blocks for common "not found" scenarios

### Adding New MediaService Methods

1. Add method signature to `MediaService` interface
2. Implement in `VampireSquidKiotaClient` using pattern:
   ```java
   return findMany(() ->
       vampireSquid.v1()
           .endpoint()
           .get()
   ).thenApply(list -> list.stream()
       .map(Media::fromKiota)
       .toList());
   ```
3. Use helper methods: `findOne()`, `findOneOrNull()`, `findMany()`

## Testing

- **Unit tests**: `src/test/java/*Test.java` (mocks, no network)
- **Integration tests**: `src/test/java/*IT.java` (live service required)
- Integration tests use hardcoded URL: `https://gehenna.shore.mbari.org/vam`
- Some tests assume specific data exists in test database

## Important Notes

- **DO NOT** manually edit files in `src/main/java/org/mbari/vars/vampiresquid/sdk/kiota/` - they are auto-generated
- **DO** edit files in `src/main/java/org/mbari/vars/vampiresquid/sdk/r1/` - hand-written convenience layer
- SHA512 checksums are stored as hex strings (not base64) - this is intentional workaround
- All timestamps use `OffsetDateTime` with UTC zone
- Virtual threads require Java 21+
